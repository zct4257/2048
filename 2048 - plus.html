<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048小游戏</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 - 包含更高数值方块的配色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        game: {
                            bg: '#faf8ef',
                            text: '#776e65',
                            score: '#bbada0',
                            cell: {
                                empty: '#cdc1b4',
                                2: '#eee4da',
                                4: '#ede0c8',
                                8: '#f2b179',
                                16: '#f59563',
                                32: '#f67c5f',
                                64: '#f65e3b',
                                128: '#edcf72',
                                256: '#edcc61',
                                512: '#edc850',
                                1024: '#edc53f',
                                2048: '#edc22e',
                                4096: '#ff9900',
                                8192: '#ff6600',
                                16384: '#ff3300',
                                32768: '#ff0000',
                                65536: '#cc0000',
                                131072: '#990000',
                                super: '#3c3a32'
                            }
                        }
                    },
                    fontFamily: {
                        game: ['"Clear Sans"', 'Helvetica Neue', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .cell-transition {
                transition: all 0.2s ease;
            }
            .tile-appear {
                animation: tileAppear 0.3s ease-out;
            }
            .tile-merge {
                animation: tileMerge 0.2s ease-out;
            }
        }
    </style>
    
    <style>
        @keyframes tileAppear {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes tileMerge {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes gameOver {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .game-over-shake {
            animation: gameOver 0.5s ease-in-out;
        }
        
        /* 为超高数值方块添加额外样式 */
        .tile-super-large {
            font-size: 0.8rem !important;
        }
    </style>
</head>
<body class="bg-game-bg font-game text-game-text min-h-screen flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full mx-auto">
        <!-- 游戏标题和分数 -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold">2048</h1>
            
            <div class="flex gap-2">
                <div class="bg-game-score rounded-md px-3 py-2 text-white text-center">
                    <div class="text-xs uppercase font-bold">分数</div>
                    <div id="score" class="text-lg font-bold">0</div>
                </div>
                <div class="bg-game-score rounded-md px-3 py-2 text-white text-center">
                    <div class="text-xs uppercase font-bold">最高分</div>
                    <div id="best-score" class="text-lg font-bold">0</div>
                </div>
            </div>
        </header>
        
        <!-- 游戏说明和控制按钮 -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
            <p class="text-sm">使用方向键或 swipe 移动方块，相同数字合并后得分！</p>
            <button id="new-game" class="bg-game-score hover:bg-opacity-90 text-white px-4 py-2 rounded-md transition-all font-bold text-sm">
                新游戏
            </button>
        </div>
        
        <!-- 游戏容器 -->
        <div class="relative bg-game-score rounded-xl p-4 mb-6" id="outer-container">
            <!-- 游戏网格背景 -->
            <div id="game-container" class="grid grid-cols-4 gap-4">
                <!-- 空单元格背景 -->
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
                <div class="bg-game-cell-empty rounded-md aspect-square"></div>
            </div>
            
            <!-- 游戏方块将动态添加到这里 -->
            <div id="tiles-container" class="absolute inset-0 p-4 grid grid-cols-4 gap-4 pointer-events-none"></div>
            
            <!-- 游戏结束遮罩 -->
            <div id="game-over" class="absolute inset-0 bg-black bg-opacity-50 rounded-xl flex flex-col items-center justify-center gap-4 hidden">
                <h2 class="text-white text-2xl font-bold">游戏结束!</h2>
                <button id="try-again" class="bg-game-score hover:bg-opacity-90 text-white px-6 py-3 rounded-md transition-all font-bold">
                    再玩一次
                </button>
            </div>
            
            <!-- 胜利遮罩 - 仅短暂显示 -->
            <div id="game-win" class="absolute inset-0 bg-black bg-opacity-50 rounded-xl flex flex-col items-center justify-center gap-4 hidden">
                <h2 class="text-white text-2xl font-bold">恭喜你合成了2048!</h2>
                <p class="text-white">已自动开启无尽模式，挑战更高分数吧！</p>
                <button id="continue" class="bg-game-score hover:bg-opacity-90 text-white px-6 py-3 rounded-md transition-all font-bold">
                    继续游戏
                </button>
            </div>
        </div>
        
        <!-- 游戏操作提示 -->
        <div class="text-center text-sm">
            <p class="mb-2">在移动设备上，你可以滑动屏幕来移动方块</p>
            <p>在电脑上，使用方向键 (↑ ↓ ← →) 来移动方块</p>
        </div>
    </div>

    <script>
        // 游戏核心逻辑
        document.addEventListener('DOMContentLoaded', () => {
            // 游戏配置
            const SIZE = 4; // 4x4 网格
            const WINNING_VALUE = 2048;
            const MAX_PREDEFINED_VALUE = 131072; // 预定义的最大方块值
            
            // 游戏状态
            let grid = [];
            let score = 0;
            let bestScore = localStorage.getItem('2048-best-score') || 0;
            let gameOver = false;
            let hasWon = false;
            let cellSize; // 单元格大小
            let gapSize; // 网格间距
            let paddingSize; // 容器内边距
            
            // DOM 元素
            const tilesContainer = document.getElementById('tiles-container');
            const scoreElement = document.getElementById('score');
            const bestScoreElement = document.getElementById('best-score');
            const newGameButton = document.getElementById('new-game');
            const tryAgainButton = document.getElementById('try-again');
            const continueButton = document.getElementById('continue');
            const newWinGameButton = document.getElementById('new-win-game');
            const gameOverElement = document.getElementById('game-over');
            const gameWinElement = document.getElementById('game-win');
            const gameContainer = document.getElementById('game-container');
            const outerContainer = document.getElementById('outer-container');
            
            // 计算布局参数
            function calculateLayout() {
                // 获取实际的网格间距 (gap) - 从CSS类gap-4转换为像素
                gapSize = 16; // gap-4 对应 16px
                
                // 获取容器内边距 (padding) - 从CSS类p-4转换为像素
                paddingSize = 16; // p-4 对应 16px
                
                // 计算单元格大小
                const containerWidth = gameContainer.offsetWidth;
                const totalGap = (SIZE - 1) * gapSize;
                cellSize = (containerWidth - totalGap) / SIZE;
                
                return { cellSize, gapSize, paddingSize };
            }
            
            // 更新分数显示
            function updateScoreDisplay() {
                scoreElement.textContent = score;
                bestScoreElement.textContent = bestScore;
                
                // 保存最高分到本地存储
                if (score > bestScore) {
                    bestScore = score;
                    localStorage.setItem('2048-best-score', bestScore);
                    bestScoreElement.textContent = bestScore;
                }
            }
            
            // 初始化网格
            function initializeGrid() {
                calculateLayout(); // 计算布局参数
                grid = Array(SIZE).fill().map(() => Array(SIZE).fill(null));
                score = 0;
                gameOver = false;
                hasWon = false;
                
                // 隐藏游戏结束和胜利提示
                gameOverElement.classList.add('hidden');
                gameWinElement.classList.add('hidden');
                
                // 添加两个初始方块
                addNewTile();
                addNewTile();
                
                // 更新显示
                renderGrid();
                updateScoreDisplay();
                
                // 监听窗口大小变化，重新计算布局
                window.addEventListener('resize', () => {
                    calculateLayout();
                    renderGrid();
                });
            }
            
            // 在随机空位置添加新方块 (90% 概率是 2，10% 概率是 4)
            function addNewTile() {
                // 收集所有空位置
                const emptyCells = [];
                for (let row = 0; row < SIZE; row++) {
                    for (let col = 0; col < SIZE; col++) {
                        if (grid[row][col] === null) {
                            emptyCells.push({ row, col });
                        }
                    }
                }
                
                // 如果没有空位置，返回 false
                if (emptyCells.length === 0) {
                    return false;
                }
                
                // 随机选择一个空位置
                const randomIndex = Math.floor(Math.random() * emptyCells.length);
                const { row, col } = emptyCells[randomIndex];
                
                // 确定生成的方块值 - 随着游戏进展，有小概率生成更高值
                let value;
                const maxValue = getMaxValue();
                
                // 游戏初期主要生成2和4
                if (maxValue < 512) {
                    value = Math.random() < 0.9 ? 2 : 4;
                } 
                // 当出现较高数值后，有小概率生成8
                else if (maxValue < 2048) {
                    value = Math.random() < 0.85 ? 2 : (Math.random() < 0.8 ? 4 : 8);
                }
                // 无尽模式下，有极小概率生成更高值
                else {
                    value = Math.random() < 0.8 ? 2 : (Math.random() < 0.7 ? 4 : 8);
                }
                
                // 在该位置添加新方块
                grid[row][col] = {
                    value,
                    merged: false,
                    new: true
                };
                
                return true;
            }
            
            // 获取当前网格中的最大值
            function getMaxValue() {
                let max = 0;
                for (let row = 0; row < SIZE; row++) {
                    for (let col = 0; col < SIZE; col++) {
                        if (grid[row][col] && grid[row][col].value > max) {
                            max = grid[row][col].value;
                        }
                    }
                }
                return max;
            }
            
            // 渲染网格和方块
            function renderGrid() {
                // 清空现有方块
                tilesContainer.innerHTML = '';
                
                // 渲染每个方块
                for (let row = 0; row < SIZE; row++) {
                    for (let col = 0; col < SIZE; col++) {
                        const cell = grid[row][col];
                        if (cell) {
                            const tile = document.createElement('div');
                            
                            // 精确计算位置，考虑内边距和间距
                            const leftPos = paddingSize + col * (cellSize + gapSize);
                            const topPos = paddingSize + row * (cellSize + gapSize);
                            
                            // 设置方块样式
                            tile.className = `rounded-md flex items-center justify-center font-bold cell-transition absolute`;
                            tile.style.width = `${cellSize}px`;
                            tile.style.height = `${cellSize}px`;
                            tile.style.left = `${leftPos}px`;
                            tile.style.top = `${topPos}px`;
                            
                            // 根据方块值设置背景色
                            if (cell.value <= MAX_PREDEFINED_VALUE) {
                                tile.classList.add(`bg-game-cell-${cell.value}`);
                            } else {
                                // 对于超过预定义最大值的方块，使用超级方块样式
                                tile.classList.add('bg-game-cell-super');
                            }
                            
                            // 设置文字颜色 - 高数值方块使用白色文字
                            if (cell.value === 2 || cell.value === 4) {
                                tile.classList.add('text-game-text');
                            } else {
                                tile.classList.add('text-white');
                            }
                            
                            // 设置文字大小 (值越大，文字越小)
                            if (cell.value < 100) {
                                tile.classList.add('text-xl');
                            } else if (cell.value < 1000) {
                                tile.classList.add('text-lg');
                            } else if (cell.value < 10000) {
                                tile.classList.add('text-base');
                            } else {
                                // 对于非常大的数值，使用更小的字体
                                tile.classList.add('tile-super-large');
                            }
                            
                            // 设置方块值
                            tile.textContent = cell.value;
                            
                            // 添加出现动画
                            if (cell.new) {
                                tile.classList.add('tile-appear');
                                cell.new = false; // 动画只播放一次
                            }
                            
                            // 添加合并动画
                            if (cell.merged) {
                                tile.classList.add('tile-merge');
                                cell.merged = false; // 动画只播放一次
                            }
                            
                            tilesContainer.appendChild(tile);
                        }
                    }
                }
            }
            
            // 检查游戏是否结束
            function checkGameOver() {
                // 检查是否还有空位置
                for (let row = 0; row < SIZE; row++) {
                    for (let col = 0; col < SIZE; col++) {
                        if (grid[row][col] === null) {
                            return false; // 还有空位置，游戏未结束
                        }
                    }
                }
                
                // 检查是否还有可合并的方块
                for (let row = 0; row < SIZE; row++) {
                    for (let col = 0; col < SIZE; col++) {
                        const current = grid[row][col].value;
                        // 检查右侧
                        if (col < SIZE - 1 && grid[row][col + 1].value === current) {
                            return false;
                        }
                        // 检查下方
                        if (row < SIZE - 1 && grid[row + 1][col].value === current) {
                            return false;
                        }
                    }
                }
                
                // 没有空位置且没有可合并的方块，游戏结束
                return true;
            }
            
            // 检查是否获胜(合成2048)
            function checkWin() {
                return getMaxValue() >= WINNING_VALUE;
            }
            
            // 处理移动 - 向左
            function moveLeft() {
                let moved = false;
                
                for (let row = 0; row < SIZE; row++) {
                    // 处理当前行
                    for (let col = 1; col < SIZE; col++) {
                        if (grid[row][col] !== null) {
                            let currentCol = col;
                            
                            // 向左移动直到不能再移动
                            while (currentCol > 0 && grid[row][currentCol - 1] === null) {
                                // 移动方块
                                grid[row][currentCol - 1] = grid[row][currentCol];
                                grid[row][currentCol] = null;
                                currentCol--;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (currentCol > 0 && 
                                grid[row][currentCol - 1] !== null && 
                                grid[row][currentCol - 1].value === grid[row][currentCol].value &&
                                !grid[row][currentCol - 1].merged &&
                                !grid[row][currentCol].merged) {
                                
                                // 合并方块
                                grid[row][currentCol - 1].value *= 2;
                                grid[row][currentCol - 1].merged = true;
                                grid[row][currentCol - 1].new = false;
                                
                                // 增加分数
                                score += grid[row][currentCol - 1].value;
                                
                                grid[row][currentCol] = null;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 处理移动 - 向右
            function moveRight() {
                let moved = false;
                
                for (let row = 0; row < SIZE; row++) {
                    // 处理当前行
                    for (let col = SIZE - 2; col >= 0; col--) {
                        if (grid[row][col] !== null) {
                            let currentCol = col;
                            
                            // 向右移动直到不能再移动
                            while (currentCol < SIZE - 1 && grid[row][currentCol + 1] === null) {
                                // 移动方块
                                grid[row][currentCol + 1] = grid[row][currentCol];
                                grid[row][currentCol] = null;
                                currentCol++;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (currentCol < SIZE - 1 && 
                                grid[row][currentCol + 1] !== null && 
                                grid[row][currentCol + 1].value === grid[row][currentCol].value &&
                                !grid[row][currentCol + 1].merged &&
                                !grid[row][currentCol].merged) {
                                
                                // 合并方块
                                grid[row][currentCol + 1].value *= 2;
                                grid[row][currentCol + 1].merged = true;
                                grid[row][currentCol + 1].new = false;
                                
                                // 增加分数
                                score += grid[row][currentCol + 1].value;
                                
                                grid[row][currentCol] = null;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 处理移动 - 向上
            function moveUp() {
                let moved = false;
                
                for (let col = 0; col < SIZE; col++) {
                    // 处理当前列
                    for (let row = 1; row < SIZE; row++) {
                        if (grid[row][col] !== null) {
                            let currentRow = row;
                            
                            // 向上移动直到不能再移动
                            while (currentRow > 0 && grid[currentRow - 1][col] === null) {
                                // 移动方块
                                grid[currentRow - 1][col] = grid[currentRow][col];
                                grid[currentRow][col] = null;
                                currentRow--;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (currentRow > 0 && 
                                grid[currentRow - 1][col] !== null && 
                                grid[currentRow - 1][col].value === grid[currentRow][col].value &&
                                !grid[currentRow - 1][col].merged &&
                                !grid[currentRow][col].merged) {
                                
                                // 合并方块
                                grid[currentRow - 1][col].value *= 2;
                                grid[currentRow - 1][col].merged = true;
                                grid[currentRow - 1][col].new = false;
                                
                                // 增加分数
                                score += grid[currentRow - 1][col].value;
                                
                                grid[currentRow][col] = null;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 处理移动 - 向下
            function moveDown() {
                let moved = false;
                
                for (let col = 0; col < SIZE; col++) {
                    // 处理当前列
                    for (let row = SIZE - 2; row >= 0; row--) {
                        if (grid[row][col] !== null) {
                            let currentRow = row;
                            
                            // 向下移动直到不能再移动
                            while (currentRow < SIZE - 1 && grid[currentRow + 1][col] === null) {
                                // 移动方块
                                grid[currentRow + 1][col] = grid[currentRow][col];
                                grid[currentRow][col] = null;
                                currentRow++;
                                moved = true;
                            }
                            
                            // 检查是否可以合并
                            if (currentRow < SIZE - 1 && 
                                grid[currentRow + 1][col] !== null && 
                                grid[currentRow + 1][col].value === grid[currentRow][col].value &&
                                !grid[currentRow + 1][col].merged &&
                                !grid[currentRow][col].merged) {
                                
                                // 合并方块
                                grid[currentRow + 1][col].value *= 2;
                                grid[currentRow + 1][col].merged = true;
                                grid[currentRow + 1][col].new = false;
                                
                                // 增加分数
                                score += grid[currentRow + 1][col].value;
                                
                                grid[currentRow][col] = null;
                                moved = true;
                            }
                        }
                    }
                }
                
                return moved;
            }
            
            // 处理移动
            function handleMove(direction) {
                if (gameOver) {
                    return;
                }
                
                let moved = false;
                
                // 根据方向处理移动
                switch (direction) {
                    case 'left':
                        moved = moveLeft();
                        break;
                    case 'right':
                        moved = moveRight();
                        break;
                    case 'up':
                        moved = moveUp();
                        break;
                    case 'down':
                        moved = moveDown();
                        break;
                }
                
                // 如果有移动，添加新方块并重新渲染
                if (moved) {
                    // 添加新方块
                    addNewTile();
                    
                    // 更新分数显示
                    updateScoreDisplay();
                    
                    // 重新渲染
                    renderGrid();
                    
                    // 检查是否获胜(第一次合成2048时显示提示)
                    if (!hasWon && checkWin()) {
                        hasWon = true;
                        gameWinElement.classList.remove('hidden');
                        
                        // 5秒后自动隐藏胜利提示，进入无尽模式
                        setTimeout(() => {
                            gameWinElement.classList.add('hidden');
                        }, 5000);
                    } 
                    // 检查游戏是否结束
                    else if (checkGameOver()) {
                        gameOver = true;
                        gameOverElement.classList.remove('hidden');
                        gameOverElement.classList.add('game-over-shake');
                        
                        // 移除动画类，以便下次可以重新触发
                        setTimeout(() => {
                            gameOverElement.classList.remove('game-over-shake');
                        }, 500);
                    }
                }
            }
            
            // 键盘事件监听
            document.addEventListener('keydown', (e) => {
                // 阻止方向键导致页面滚动
                if ([37, 38, 39, 40].includes(e.keyCode)) {
                    e.preventDefault();
                }
                
                // 处理方向键
                switch (e.keyCode) {
                    case 37: // 左箭头
                        handleMove('left');
                        break;
                    case 38: // 上箭头
                        handleMove('up');
                        break;
                    case 39: // 右箭头
                        handleMove('right');
                        break;
                    case 40: // 下箭头
                        handleMove('down');
                        break;
                }
            });
            
            // 触摸事件处理 (移动设备)
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, false);
            
            document.addEventListener('touchend', (e) => {
                if (!touchStartX || !touchStartY) {
                    return;
                }
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;
                
                // 确定滑动方向 (优先考虑距离更长的方向)
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    // 水平滑动
                    if (Math.abs(diffX) > 20) { // 最小滑动距离
                        diffX > 0 ? handleMove('right') : handleMove('left');
                    }
                } else {
                    // 垂直滑动
                    if (Math.abs(diffY) > 20) { // 最小滑动距离
                        diffY > 0 ? handleMove('down') : handleMove('up');
                    }
                }
                
                // 重置触摸起始位置
                touchStartX = 0;
                touchStartY = 0;
            }, false);
            
            // 按钮事件监听
            newGameButton.addEventListener('click', initializeGrid);
            tryAgainButton.addEventListener('click', initializeGrid);
            continueButton.addEventListener('click', () => {
                gameWinElement.classList.add('hidden');
            });
            
            // 初始化游戏
            initializeGrid();
        });
    </script>
</body>
</html>
    